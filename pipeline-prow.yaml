####### Do not edit this file use make generate
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: prow-commands
  annotations:
    pipelinesascode.tekton.dev/on-comment: |
      ^/(help|lgtm|(assign|unassign|label|unlabel)[ ].*)$
    pipelinesascode.tekton.dev/max-keep-runs: '5'
spec:
  params:
  - name: repo_owner
  - name: repo_name
  - name: pull_request_number
  - name: pull_request_sender
  - name: git_auth_secret
  - name: git_auth_secret_key
    default: git-provider-token
  - name: trigger_comment
  tasks:
  - name: manage-pr
    displayName: Manage PR Assignments & Labels
    taskSpec:
      steps:
      - name: manage-pr
        image: registry.access.redhat.com/ubi9/ubi
        env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.git_auth_secret)
              key: $(params.git_auth_secret_key)
        - name: GH_REPO_OWNER
          value: $(params.repo_owner)
        - name: GH_PR_SENDER
          value: $(params.pull_request_sender)
        - name: GH_REPO_NAME
          value: $(params.repo_name)
        - name: GH_PR_NUM
          value: $(params.pull_request_number)
        - name: PAC_TRIGGER_COMMENT
          value: |
            $(params.trigger_comment)
        script: |
          #!/usr/bin/env python3
          # Copyright 2025 Red Hat, Inc.
          # Author: Chmouel Boudjnah <chmouel@redhat.com>
          import os
          import re
          import sys

          import requests

          GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
          GH_PR_NUM = os.getenv("GH_PR_NUM")
          GH_PR_SENDER = os.getenv("GH_PR_SENDER")
          GH_REPO_OWNER = os.getenv("GH_REPO_OWNER")
          GH_REPO_NAME = os.getenv("GH_REPO_NAME")
          PAC_TRIGGER_COMMENT = os.getenv("PAC_TRIGGER_COMMENT", "")
          API_BASE = f"https://api.github.com/repos/{GH_REPO_OWNER}/{GH_REPO_NAME}"
          API_ISSUE = f"{API_BASE}/issues/{GH_PR_NUM}"
          API_PULLS = f"{API_BASE}/pulls/{GH_PR_NUM}"
          HEADERS = {
              "Authorization": f"Bearer {GITHUB_TOKEN}",
              "Accept": "application/vnd.github.v3+json",
          }

          LGTM_THRESHOLD = 2

          HELP_TEXT = """
          ### ü§ñ Available Commands
          | Command                   | Description                                                          |
          |---------------------------|----------------------------------------------------------------------|
          | `/assign user1 user2`     | Assigns users for review to the PR                                   |
          | `/unassign user1 user2`   | Removes assigned users                                               |
          | `/label bug feature`      | Adds labels to the PR                                                |
          | `/unlabel bug feature`    | Removes labels from the PR                                           |
          | `/lgtm`                   | Approves the PR if at least 2 org members have commented `/lgtm`     |
          | `/help`                   | Shows this help message                                              |
          """


          def post_comment(message, error=False):
              """Posts a comment to the pull request with the given message.

              Args:
                  message (str): The message to post
                  error (bool): If True, formats the message as an error

              Returns:
                  requests.Response: The response from the GitHub API
              """
              API_URL = f"{API_ISSUE}/comments"

              if error:
                  formatted_message = f"""### ‚ùå Error
          ```
          {message}
          ```"""
              else:
                  formatted_message = message

              return make_request("POST", API_URL, {"body": formatted_message})


          def make_request(method, url, data=None):
              if method == "POST":
                  return requests.post(url, json=data, headers=HEADERS)
              elif method == "DELETE":
                  return requests.delete(url, json=data, headers=HEADERS)
              return None


          def assign_unassign(command, values):
              method = "POST" if command == "assign" else "DELETE"
              API_URL = f"{API_PULLS}/requested_reviewers"
              values = [value.lstrip("@") for value in values]
              data = {"reviewers": values}
              response = make_request(method, API_URL, data)
              if response and response.status_code in [200, 201, 204]:
                  post_comment(
                      f"‚úÖ {command.capitalize()}ed <b>{', '.join(values)}</b> for reviews."
                  )
              return response


          def label(values):
              API_URL = f"{API_ISSUE}/labels"
              data = {"labels": values}
              post_comment(f"‚úÖ Added labels: <b>{', '.join(values)}</b>.")
              return make_request("POST", API_URL, data)


          def unlabel(values):
              for label in values:
                  response = make_request("DELETE", f"{API_ISSUE}/labels/{label}")
              post_comment(f"‚úÖ Removed labels: <b>{', '.join(values)}</b>.")
              return response


          def post_lgtm_breakdown(valid_votes, lgtm_users):
              """Posts a breakdown of LGTM votes as a comment.

              Args:
                  valid_votes (int): Number of valid LGTM votes
                  lgtm_users (dict): Dictionary of users and their permissions who voted LGTM
              """
              message = "### LGTM Vote Breakdown\n\n"
              message += f"Current valid votes: {valid_votes}/{LGTM_THRESHOLD}\n\n"
              message += "| User | Permission | Valid Vote |\n"
              message += "|------|------------|------------|\n"

              for user, permission in lgtm_users.items():
                  is_valid = permission in ["admin", "write"]
                  valid_mark = "‚úÖ" if is_valid else "‚ùå"
                  message += f"| @{user} | {permission} | {valid_mark} |\n"

              return post_comment(message)


          def lgtm():
              comments_resp = requests.get(API_ISSUE + "/comments", headers=HEADERS)
              if comments_resp.status_code != 200:
                  error_message = f"Failed to fetch comments: {comments_resp.status_code} - {comments_resp.text}"
                  print(error_message, file=sys.stderr)
                  sys.exit(1)

              comments = comments_resp.json()
              lgtm_users = {}
              for comment_item in comments:
                  body = comment_item.get("body", "")
                  if re.search(r"^/lgtm\b", body, re.IGNORECASE):
                      user_login = comment_item["user"]["login"]
                      if user_login == GH_PR_SENDER:
                          msg = f"User {user_login} is the PR sender and cannot /lgtm their own PR. This needs to be deleted or this won't pass"
                          post_comment(msg, error=True)
                          print(msg, file=sys.stderr)
                          sys.exit(1)
                      lgtm_users[user_login] = None

              valid_votes = 0
              for user in list(lgtm_users.keys()):
                  membership_url = f"{API_BASE}/collaborators/{user}/permission"
                  membership_resp = requests.get(membership_url, headers=HEADERS)

                  if membership_resp.status_code != 200:
                      print(
                          f"User {user} does not have admin access (status: {membership_resp.status_code})",
                          file=sys.stderr,
                      )
                      lgtm_users[user] = "none"
                      continue

                  response_data = membership_resp.json()
                  permission = response_data.get("permission")
                  if not permission:
                      print("No permission found in response", file=sys.stderr)
                      lgtm_users[user] = "none"
                      continue

                  lgtm_users[user] = permission
                  if permission in ["admin", "write"]:
                      valid_votes += 1
                  else:
                      print(
                          f"User {user} does not have write access: {response_data}",
                          file=sys.stderr,
                      )

              # Post the LGTM breakdown
              post_lgtm_breakdown(valid_votes, lgtm_users)

              if valid_votes >= LGTM_THRESHOLD:
                  API_URL = API_PULLS + "/reviews"
                  data = {"event": "APPROVE", "body": "LGTM :+1:"}
                  print("‚úÖ PR approved with LGTM votes.")
                  return make_request("POST", API_URL, data)
              else:
                  message = (
                      f"Not enough valid /lgtm votes (found {valid_votes}, need {LGTM_THRESHOLD})"
                  )
                  print(message)
                  sys.exit(0)


          def help_command():
              return post_comment(HELP_TEXT.strip())


          def check_response(command, values, response):
              if response and response.status_code in [200, 201, 204]:
                  print(
                      f"‚úÖ Successfully processed {command}: {', '.join(values) if values else ''}"
                  )
                  return True
              print(
                  f"‚ùå Failed to process {command}: {response.status_code} - {response.text}",
                  file=sys.stderr,
              )
              return False


          def main():
              match = re.match(
                  r"^/(assign|unassign|label|unlabel|lgtm|help)\s*(.*)", PAC_TRIGGER_COMMENT
              )

              if not match:
                  print(
                      f"‚ö†Ô∏è No valid command found in comment: {PAC_TRIGGER_COMMENT}",
                      file=sys.stderr,
                  )
                  sys.exit(1)

              command, values = match.groups()
              values = values.split()

              if command == "assign" or command == "unassign":
                  response = assign_unassign(command, values)
              elif command == "label":
                  response = label(values)
              elif command == "unlabel":
                  response = unlabel(values)
              elif command == "lgtm":
                  response = lgtm()
              elif command == "help":
                  response = help_command()

              if not check_response(command, values, response):
                  sys.exit(1)


          if __name__ == "__main__":
              main()
